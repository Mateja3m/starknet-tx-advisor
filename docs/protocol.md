# Protocol Spec (PoC)

## Overview

The dApp constructs wallet request URLs using `srn-wallet://` routes and `payload=<base64(json)>` query param.
The wallet returns responses to the callback URL (normally `srn-dapp://callback`) with the same encoding.

## Routes

Wallet request routes:
- `srn-wallet://connect?payload=...`
- `srn-wallet://sign?payload=...`
- `srn-wallet://execute?payload=...`

dApp callback route:
- `srn-dapp://callback?payload=...`

## Request Schema

```json
{
  "type": "CONNECT | SIGN | EXECUTE_TX",
  "callbackUrl": "srn-dapp://callback",
  "requestId": "string",
  "state": "string",
  "nonce": "string",
  "createdAt": 1739870000000,
  "appName": "string (CONNECT only)",
  "message": "string (SIGN only)",
  "tx": { "to": "...", "amount": "..." } (EXECUTE_TX only)
}
```

## Response Schema

```json
{
  "requestId": "string",
  "state": "string",
  "nonce": "string",
  "type": "CONNECT | SIGN | EXECUTE_TX",
  "status": "APPROVED | REJECTED",
  "timestamp": 1739870000000,
  "data": {
    "walletAddress": "0xMOCK...",
    "sessionId": "...",
    "signature": "...",
    "txHash": "0xMOCKTX...",
    "status": "WALLET_APPROVED"
  },
  "errorCode": "optional",
  "errorMessage": "optional"
}
```

## Security Notes

- `state` is generated by dApp per request and must match in response.
- `requestId` is used to correlate pending request map.
- `nonce` is included in payload for replay-hardening in PoC structure.
- dApp discards callback when:
  - requestId is unknown
  - state mismatch occurs
  - response is malformed

## Error Codes

- `USER_REJECTED`: User rejected request in wallet.
- `STATE_MISMATCH`: dApp validation failed.
- `UNKNOWN_REQUEST`: callback requestId not found in pending map.
- `MALFORMED_RESPONSE`: callback payload parse/shape invalid.
- `UNSUPPORTED_TYPE`: wallet got unsupported request type.

## Signature (Mock)

Wallet generates signature as:

```text
base64(sha256(serializedPayload + "srn-mock-secret"))
```

This is for protocol testing only and is not cryptographically compatible with Starknet account signatures.
